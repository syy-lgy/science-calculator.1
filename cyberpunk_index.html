<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CYBER CALC - 数理化学计算专家</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cyber: {
                            primary: '#00ffff',
                            secondary: '#ff00ff',
                            accent: '#ffff00',
                            dark: '#0a0a0a',
                            darker: '#050505',
                            purple: '#8b00ff',
                            green: '#00ff41',
                            pink: '#ff0080'
                        }
                    },
                    fontFamily: {
                        mono: ['Courier New', 'monospace'],
                        cyber: ['Orbitron', 'monospace']
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        
        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0033 50%, #000a1a 100%);
            overflow-x: hidden;
        }
        
        .cyber-grid {
            background-image: 
                linear-gradient(rgba(0,255,255,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,255,255,0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: grid-move 20s linear infinite;
        }
        
        @keyframes grid-move {
            0% { background-position: 0 0; }
            100% { background-position: 50px 50px; }
        }
        
        .neon-border {
            border: 2px solid #00ffff;
            box-shadow: 
                0 0 10px #00ffff,
                inset 0 0 10px rgba(0,255,255,0.1);
        }
        
        .neon-text {
            text-shadow: 
                0 0 5px currentColor,
                0 0 10px currentColor,
                0 0 15px currentColor;
        }
        
        .cyber-button {
            background: linear-gradient(45deg, #00ffff, #ff00ff);
            border: none;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .cyber-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,255,255,0.3);
        }
        
        .cyber-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .cyber-button:hover::before {
            left: 100%;
        }
        
        .glitch {
            animation: glitch 2s infinite;
        }
        
        @keyframes glitch {
            0%, 100% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
        }
        
        .cyber-card {
            background: rgba(0,0,0,0.8);
            border: 1px solid #00ffff;
            box-shadow: 
                0 0 20px rgba(0,255,255,0.2),
                inset 0 0 20px rgba(0,255,255,0.05);
            backdrop-filter: blur(10px);
        }
        
        .cyber-input {
            background: rgba(0,0,0,0.7);
            border: 1px solid #00ffff;
            color: #00ffff;
            transition: all 0.3s ease;
        }
        
        .cyber-input:focus {
            border-color: #ff00ff;
            box-shadow: 0 0 10px #ff00ff;
            outline: none;
        }
        
        .matrix-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .floating-particles {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #00ffff;
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 1; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 0.5; }
        }
        
        .scan-line {
            position: relative;
            overflow: hidden;
        }
        
        .scan-line::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00ffff, transparent);
            animation: scan 3s linear infinite;
        }
        
        @keyframes scan {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
    </style>
</head>
<body class="min-h-screen font-mono text-cyber-primary cyber-grid">
    <!-- Matrix Background -->
    <div class="matrix-bg">
        <canvas id="matrix-canvas"></canvas>
    </div>
    
    <!-- Floating Particles -->
    <div class="floating-particles" style="top: 10%; left: 10%; animation-delay: 0s;"></div>
    <div class="floating-particles" style="top: 20%; left: 80%; animation-delay: 1s;"></div>
    <div class="floating-particles" style="top: 60%; left: 20%; animation-delay: 2s;"></div>
    <div class="floating-particles" style="top: 80%; left: 70%; animation-delay: 3s;"></div>
    
    <!-- Header -->
    <header class="relative z-10 bg-black/50 backdrop-blur-md border-b border-cyber-primary">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-microchip text-3xl text-cyber-secondary glitch"></i>
                    <h1 class="text-2xl md:text-3xl font-cyber font-bold neon-text text-cyber-primary">
                        CYBER CALC
                    </h1>
                    <span class="text-sm text-cyber-green font-mono">[v2.077]</span>
                </div>
                <div class="hidden md:flex space-x-6 text-sm font-mono">
                    <a href="#math" class="text-cyber-primary hover:text-cyber-secondary transition-colors">[MATH]</a>
                    <a href="#physics" class="text-cyber-primary hover:text-cyber-secondary transition-colors">[PHYSICS]</a>
                    <a href="#chemistry" class="text-cyber-primary hover:text-cyber-secondary transition-colors">[CHEMISTRY]</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8 relative z-10">
        <!-- Hero Section -->
        <section class="text-center mb-12">
            <h2 class="text-4xl md:text-6xl font-cyber font-black mb-6 neon-text text-cyber-primary glitch">
                NEURAL CALCULATOR
            </h2>
            <div class="max-w-4xl mx-auto cyber-card rounded-lg p-6 scan-line">
                <p class="text-cyber-green font-mono text-sm md:text-base leading-relaxed">
                    > INITIALIZING QUANTUM COMPUTATION MATRIX...<br>
                    > LOADING MATHEMATICAL ALGORITHMS...<br>
                    > ACTIVATING HESS LAW PROTOCOLS...<br>
                    > SYSTEM READY FOR NEURAL INTERFACE<br><br>
                    <span class="text-cyber-secondary">WARNING:</span> 
                    <span class="text-cyber-primary">ADVANCED CALCULATION SYSTEM DETECTED</span>
                </p>
            </div>
        </section>

        <!-- Calculator Interface -->
        <section class="max-w-6xl mx-auto cyber-card rounded-lg p-8 mb-12">
            <!-- Terminal Header -->
            <div class="flex items-center justify-between mb-6 pb-4 border-b border-cyber-primary">
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 rounded-full bg-red-500"></div>
                    <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                    <div class="w-3 h-3 rounded-full bg-green-500"></div>
                </div>
                <span class="font-mono text-xs text-cyber-green">NEURAL_CALC_TERMINAL_v2.077</span>
            </div>
            
            <!-- Result Display -->
            <div class="mb-8 cyber-card rounded-lg p-6 bg-black/60">
                <div class="flex items-center mb-2">
                    <span class="text-cyber-green font-mono text-sm">输出:</span>
                    <div class="ml-2 w-2 h-2 bg-cyber-green rounded-full animate-pulse"></div>
                </div>
                <div id="result" class="text-2xl font-mono min-h-[3rem] flex items-center text-cyber-primary">
                    <span class="text-cyber-green">$ </span>
                    <span class="ml-2 text-gray-500">等待输入...</span>
                </div>
            </div>

            <!-- Subject Selection -->
            <div class="mb-8">
                <label class="block text-cyber-secondary font-mono text-sm mb-4">选择模块:</label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button id="math-btn" class="cyber-button text-black font-bold py-4 px-6 rounded-lg font-mono">
                        <i class="fas fa-square-root-alt mr-2"></i>数学模块
                    </button>
                    <button id="physics-btn" class="cyber-button text-black font-bold py-4 px-6 rounded-lg font-mono">
                        <i class="fas fa-atom mr-2"></i>物理模块
                    </button>
                    <button id="chemistry-btn" class="cyber-button text-black font-bold py-4 px-6 rounded-lg font-mono">
                        <i class="fas fa-flask mr-2"></i>化学模块
                    </button>
                </div>
            </div>

            <!-- Operation Selection -->
            <div class="mb-8">
                <label class="block text-cyber-secondary font-mono text-sm mb-4">运算类型:</label>
                <select id="operation" class="w-full cyber-input p-4 rounded-lg font-mono">
                    <option value="">请先选择模块</option>
                </select>
            </div>

            <!-- Parameters Input -->
            <div id="params-container" class="mb-8 space-y-6">
                <!-- Dynamic content -->
            </div>

            <!-- Execute Button -->
            <button id="calculate-btn" class="w-full cyber-button text-black font-bold py-4 px-6 rounded-lg font-mono text-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <i class="fas fa-play mr-2"></i>执行计算
            </button>
        </section>

        <!-- Module Cards -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
            <!-- Math Module -->
            <div id="math" class="cyber-card rounded-lg overflow-hidden">
                <div class="bg-gradient-to-r from-cyber-primary to-cyber-secondary p-6">
                    <h3 class="text-xl font-cyber font-bold text-black flex items-center">
                        <i class="fas fa-square-root-alt mr-3"></i>MATH_MODULE
                    </h3>
                </div>
                <div class="p-6">
                    <ul class="space-y-3 text-sm font-mono">
                        <li class="flex items-center"><i class="fas fa-chevron-right text-cyber-green mr-2"></i>ALGEBRA_OPERATIONS</li>
                        <li class="flex items-center"><i class="fas fa-chevron-right text-cyber-green mr-2"></i>CALCULUS_ENGINE</li>
                        <li class="flex items-center"><i class="fas fa-chevron-right text-cyber-green mr-2"></i>MATRIX_PROCESSOR</li>
                        <li class="flex items-center"><i class="fas fa-chevron-right text-cyber-green mr-2"></i>STATISTICS_CORE</li>
                        <li class="flex items-center"><i class="fas fa-chevron-right text-cyber-green mr-2"></i>GEOMETRY_CALC</li>
                    </ul>
                </div>
            </div>

            <!-- Physics Module -->
            <div id="physics" class="cyber-card rounded-lg overflow-hidden">
                <div class="bg-gradient-to-r from-cyber-secondary to-cyber-purple p-6">
                    <h3 class="text-xl font-cyber font-bold text-black flex items-center">
                        <i class="fas fa-atom mr-3"></i>PHYSICS_MODULE
                    </h3>
                </div>
                <div class="p-6">
                    <ul class="space-y-3 text-sm font-mono">
                        <li class="flex items-center"><i class="fas fa-chevron-right text-cyber-pink mr-2"></i>MECHANICS_SIM</li>
                        <li class="flex items-center"><i class="fas fa-chevron-right text-cyber-pink mr-2"></i>THERMAL_CALC</li>
                        <li class="flex items-center"><i class="fas fa-chevron-right text-cyber-pink mr-2"></i>ELECTRO_DYNAMICS</li>
                        <li class="flex items-center"><i class="fas fa-chevron-right text-cyber-pink mr-2"></i>OPTICS_ENGINE</li>
                    </ul>
                </div>
            </div>

            <!-- Chemistry Module -->
            <div id="chemistry" class="cyber-card rounded-lg overflow-hidden">
                <div class="bg-gradient-to-r from-cyber-purple to-cyber-accent p-6">
                    <h3 class="text-xl font-cyber font-bold text-black flex items-center">
                        <i class="fas fa-flask mr-3"></i>CHEM_MODULE
                    </h3>
                </div>
                <div class="p-6">
                    <ul class="space-y-3 text-sm font-mono">
                        <li class="flex items-center"><i class="fas fa-chevron-right text-cyber-accent mr-2"></i>HESS_LAW_PROTOCOL</li>
                        <li class="flex items-center"><i class="fas fa-chevron-right text-cyber-accent mr-2"></i>ENTHALPY_CALC</li>
                        <li class="flex items-center"><i class="fas fa-chevron-right text-cyber-accent mr-2"></i>STOICHIOMETRY</li>
                        <li class="flex items-center"><i class="fas fa-chevron-right text-cyber-accent mr-2"></i>EQUILIBRIUM_SIM</li>
                        <li class="flex items-center"><i class="fas fa-chevron-right text-cyber-accent mr-2"></i>THERMOCHEM_ENGINE</li>
                    </ul>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-black/80 border-t border-cyber-primary py-8 relative z-10">
        <div class="container mx-auto px-4 text-center">
            <p class="font-mono text-cyber-green mb-2">CYBER_CALC_SYSTEM_v2.077</p>
            <p class="font-mono text-xs text-gray-500">© 2077 NEURAL_DYNAMICS_CORP</p>
        </div>
    </footer>

    <script>
        // Matrix Rain Effect
        const canvas = document.getElementById('matrix-canvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        const matrix = "ABCDEFGHIJKLMNOPQRSTUVWXYZ123456789@#$%^&*()*&^%+-/~{[|`]}";
        const matrixArray = matrix.split("");
        
        const fontSize = 10;
        const columns = canvas.width / fontSize;
        
        const drops = [];
        for(let x = 0; x < columns; x++) {
            drops[x] = 1;
        }
        
        function drawMatrix() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.04)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#00ffff';
            ctx.font = fontSize + 'px monospace';
            
            for(let i = 0; i < drops.length; i++) {
                const text = matrixArray[Math.floor(Math.random() * matrixArray.length)];
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                
                if(drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                    drops[i] = 0;
                }
                drops[i]++;
            }
        }
        
        setInterval(drawMatrix, 35);
        
        // Resize canvas on window resize
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        // Calculator Logic (same as before but with cyberpunk styling)
        const subjectOperations = {
            math: {
                label: '数学运算',
                operations: {
                    addition: { label: '加法运算', params: ['数值1', '数值2', '数值3[可选]'], type: 'basic' },
                    subtraction: { label: '减法运算', params: ['被减数', '减数1', '减数2[可选]'], type: 'basic' },
                    multiplication: { label: '乘法运算', params: ['因数1', '因数2', '因数3[可选]'], type: 'basic' },
                    division: { label: '除法运算', params: ['被除数', '除数'], type: 'basic' },
                    power: { label: '幂运算', params: ['底数', '指数'], type: 'basic' },
                    sqrt: { label: '平方根', params: ['被开方数'], type: 'basic' },
                    sin: { label: '正弦函数', params: ['角度(度)'], type: 'trigonometry' },
                    cos: { label: '余弦函数', params: ['角度(度)'], type: 'trigonometry' },
                    tan: { label: '正切函数', params: ['角度(度)'], type: 'trigonometry' },
                    log: { label: '对数函数', params: ['底数[可选]', '真数'], type: 'logarithm' },
                    ln: { label: '自然对数', params: ['真数'], type: 'logarithm' },
                    polynomial_expand: { label: '多项式展开', params: ['表达式'], type: 'algebra', inputType: 'text' },
                    polynomial_factor: { label: '因式分解', params: ['表达式'], type: 'algebra', inputType: 'text' },
                    solve_equation: { label: '方程求解', params: ['方程'], type: 'algebra', inputType: 'text' },
                    derivative: { label: '求导数', params: ['函数'], type: 'calculus', inputType: 'text' },
                    integral: { label: '不定积分', params: ['函数'], type: 'calculus', inputType: 'text' },
                    definite_integral: { label: '定积分', params: ['函数', '下限', '上限'], type: 'calculus', inputType: 'mixed' },
                    limit_calc: { label: '极限计算', params: ['函数', '极限点'], type: 'calculus', inputType: 'mixed' },
                    matrix_det: { label: '行列式', params: ['矩阵'], type: 'matrix', inputType: 'matrix' },
                    matrix_inverse: { label: '逆矩阵', params: ['矩阵'], type: 'matrix', inputType: 'matrix' },
                    matrix_eigenvalues: { label: '特征值', params: ['矩阵'], type: 'matrix', inputType: 'matrix' },
                    normal_distribution: { label: '正态分布', params: ['X值', '均值', '标准差'], type: 'statistics' },
                    binomial_probability: { label: '二项分布', params: ['试验次数', '成功次数', '成功概率'], type: 'statistics' },
                    mean_std: { label: '均值标准差', params: ['数据集'], type: 'statistics', inputType: 'array' },
                    circle_area: { label: '圆面积', params: ['半径'], type: 'geometry' },
                    sphere_volume: { label: '球体积', params: ['半径'], type: 'geometry' },
                    triangle_area: { label: '三角形面积', params: ['边长A', '边长B', '边长C'], type: 'geometry' }
                }
            },
            physics: {
                label: '物理运算',
                operations: {
                    force: { label: '力计算 (F=ma)', params: ['质量(kg)', '加速度'] },
                    work: { label: '功计算 (W=Fs)', params: ['力(N)', '位移', '角度[可选]'] },
                    power: { label: '功率计算 (P=W/t)', params: ['功(J)', '时间(s)'] },
                    kinetic_energy: { label: '动能 (½mv²)', params: ['质量(kg)', '速度'] },
                    potential_energy: { label: '势能 (mgh)', params: ['质量(kg)', '高度(m)'] },
                    momentum: { label: '动量 (p=mv)', params: ['质量(kg)', '速度'] },
                    heat: { label: '热量计算 (Q=mcΔT)', params: ['质量(kg)', '比热容', '温度变化'] },
                    ohm: { label: '欧姆定律 (V=IR)', params: ['电流(A)', '电阻'] },
                    electric_power: { label: '电功率 (P=VI)', params: ['电压(V)', '电流(A)'] },
                    snell: { label: '斯涅尔定律', params: ['折射率1', '入射角(度)', '折射率2'] }
                }
            },
            chemistry: {
                label: '化学运算',
                operations: {
                    moles_from_mass: { label: '摩尔计算 (n=m/M)', params: ['质量(g)', '摩尔质量'], type: 'basic' },
                    mass_from_moles: { label: '质量计算 (m=nM)', params: ['摩尔数', '摩尔质量'], type: 'basic' },
                    moles_from_volume: { label: '气体摩尔数 (标况)', params: ['体积(L)'], type: 'basic' },
                    molarity: { label: '摩尔浓度 (c=n/V)', params: ['摩尔数', '体积(L)'], type: 'basic' },
                    molality: { label: '质量摩尔浓度 (b=n/m)', params: ['摩尔数', '溶剂质量(kg)'], type: 'basic' },
                    ph_from_h: { label: 'pH计算 (pH=-log[H+])', params: ['氢离子浓度'], type: 'basic' },
                    h_from_ph: { label: '氢离子浓度 ([H+]=10^-pH)', params: ['pH值'], type: 'basic' },
                    stoichiometry: { label: '化学计量', params: ['已知摩尔数', '已知系数', '目标系数'], type: 'basic' },
                    hess_law: { label: '盖斯定律', params: ['已知方程式', '目标生成物'], type: 'thermochemistry', inputType: 'hess' },
                    reaction_enthalpy: { label: '反应焓', params: ['反应物焓', '生成物焓'], type: 'thermochemistry', inputType: 'array' },
                    combustion_enthalpy: { label: '燃烧焓', params: ['CO2摩尔数', 'H2O摩尔数'], type: 'thermochemistry' },
                    equilibrium_constant: { label: '平衡常数Kc', params: ['生成物浓度', '反应物浓度', '生成物系数[可选]', '反应物系数[可选]'], type: 'equilibrium', inputType: 'array' },
                    solubility: { label: '溶度积Ksp', params: ['离子浓度', '离子系数[可选]'], type: 'equilibrium', inputType: 'array' }
                }
            }
        };

        // DOM Elements
        const mathBtn = document.getElementById('math-btn');
        const physicsBtn = document.getElementById('physics-btn');
        const chemistryBtn = document.getElementById('chemistry-btn');
        const operationSelect = document.getElementById('operation');
        const paramsContainer = document.getElementById('params-container');
        const calculateBtn = document.getElementById('calculate-btn');
        const resultDisplay = document.getElementById('result');

        let currentSubject = null;

        // Subject button events
        [mathBtn, physicsBtn, chemistryBtn].forEach(btn => {
            btn.addEventListener('click', () => {
                [mathBtn, physicsBtn, chemistryBtn].forEach(b => {
                    b.classList.remove('ring-4', 'ring-cyber-primary');
                });
                btn.classList.add('ring-4', 'ring-cyber-primary');
                
                currentSubject = btn.id.split('-')[0];
                updateOperationSelect();
                paramsContainer.innerHTML = '';
                calculateBtn.disabled = true;
                resultDisplay.innerHTML = '<span class="text-cyber-green">$ </span><span class="ml-2 text-gray-500">模块已选择...</span>';
            });
        });

        // Operation selection
        operationSelect.addEventListener('change', () => {
            const operation = operationSelect.value;
            paramsContainer.innerHTML = '';
            
            if (operation) {
                const paramsConfig = subjectOperations[currentSubject].operations[operation].params;
                const operationConfig = subjectOperations[currentSubject].operations[operation];
                const inputType = operationConfig.inputType || 'number';
                
                paramsConfig.forEach((paramLabel, index) => {
                    const paramGroup = document.createElement('div');
                    paramGroup.className = 'param-group';
                    
                    let inputHtml = '';
                    const isOptional = paramLabel.includes('[OPT]');
                    
                    if (inputType === 'text' || (inputType === 'mixed' && index === 0)) {
                        inputHtml = `<input type="text" class="param-input w-full cyber-input p-3 rounded-lg font-mono"
                                           placeholder="${paramLabel}" ${isOptional ? 'data-optional="true"' : ''}>`;
                    } else if (inputType === 'matrix') {
                        inputHtml = `<textarea class="param-input w-full cyber-input p-3 rounded-lg font-mono" rows="3"
                                             placeholder="${paramLabel} FORMAT: [[1,2],[3,4]]" ${isOptional ? 'data-optional="true"' : ''}></textarea>`;
                    } else if (inputType === 'array') {
                        inputHtml = `<input type="text" class="param-input w-full cyber-input p-3 rounded-lg font-mono"
                                           placeholder="${paramLabel} (COMMA_SEPARATED)" ${isOptional ? 'data-optional="true"' : ''}>`;
                    } else if (inputType === 'hess') {
                        if (index === 0) {
                            inputHtml = `<div class="hess-equations-container">
                                            <div class="mb-4">
                                                <button type="button" class="add-equation-btn cyber-button text-black px-4 py-2 rounded font-mono text-sm">添加方程式</button>
                                            </div>
                                            <div class="equations-list space-y-3"></div>
                                        </div>`;
                        } else {
                            inputHtml = `<input type="text" class="param-input w-full cyber-input p-3 rounded-lg font-mono"
                                               placeholder="目标生成物 (如 CO2)">`;
                        }
                    } else {
                        inputHtml = `<input type="number" step="any" class="param-input w-full cyber-input p-3 rounded-lg font-mono"
                                           placeholder="${paramLabel}" ${isOptional ? 'data-optional="true"' : ''}>`;
                    }
                    
                    paramGroup.innerHTML = `
                        <label class="block text-cyber-secondary font-mono text-sm mb-2">${paramLabel}:</label>
                        ${inputHtml}
                    `;
                    paramsContainer.appendChild(paramGroup);
                });
                
                if (inputType === 'hess') {
                    setupHessLawInterface();
                }
                
                const paramInputs = document.querySelectorAll('.param-input');
                paramInputs.forEach(input => {
                    input.addEventListener('input', checkParams);
                });
                
                checkParams();
            } else {
                calculateBtn.disabled = true;
            }
        });

        // Calculate button
        calculateBtn.addEventListener('click', () => {
            const operation = operationSelect.value;
            
            if (!currentSubject || !operation) {
                resultDisplay.innerHTML = '<span class="text-cyber-green">$ </span><span class="ml-2 text-red-500">错误: 请选择模块和运算</span>';
                return;
            }
            
            let params;
            const operationConfig = subjectOperations[currentSubject].operations[operation];
            const inputType = operationConfig.inputType || 'number';
            
            if (inputType === 'hess') {
                params = getHessLawParams();
            } else {
                const paramInputs = document.querySelectorAll('.param-input');
                params = Array.from(paramInputs).map((input, index) => {
                    const value = input.value.trim();
                    if (input.dataset.optional === 'true' && value === '') {
                        return null;
                    }
                    if (value === '') {
                        return null;
                    }
                    
                    if (inputType === 'text' || (inputType === 'mixed' && index === 0)) {
                        return value;
                    } else if (inputType === 'matrix') {
                        try {
                            return JSON.parse(value);
                        } catch {
                            return null;
                        }
                    } else if (inputType === 'array') {
                        try {
                            return value.split(',').map(v => parseFloat(v.trim()));
                        } catch {
                            return null;
                        }
                    } else {
                        return parseFloat(value);
                    }
                });
            }
            
            resultDisplay.innerHTML = '<span class="text-cyber-green">$ </span><span class="ml-2 text-cyber-accent">处理中...</span>';
            
            fetch('/calculate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    subject: currentSubject,
                    operation: operation,
                    params: params
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    resultDisplay.innerHTML = `<span class="text-cyber-green">$ </span><span class="ml-2 text-red-500">错误: ${data.error}</span>`;
                } else {
                    let resultText = data.result;
                    
                    if (typeof resultText === 'object' && resultText !== null) {
                        if (resultText.success !== undefined) {
                            if (resultText.success) {
                                resultDisplay.innerHTML = `
                                    <div class="cyber-card rounded-lg p-4 bg-green-900/20 border-green-500">
                                        <div class="text-cyber-green font-mono text-sm mb-2">计算成功:</div>
                                        <div class="text-cyber-primary mb-2">目标: ${resultText.target_product}</div>
                                        <div class="text-cyber-primary mb-2">方程式: ${resultText.matched_equation}</div>
                                        <div class="text-cyber-accent text-lg">结果: ΔH = ${resultText.delta_h} kJ/mol</div>
                                    </div>
                                `;
                            } else {
                                resultDisplay.innerHTML = `<span class="text-cyber-green">$ </span><span class="ml-2 text-red-500">${resultText.message}</span>`;
                            }
                        } else if (Array.isArray(resultText)) {
                            resultDisplay.innerHTML = `<span class="text-cyber-green">$ </span><span class="ml-2 text-cyber-primary">${JSON.stringify(resultText)}</span>`;
                        } else {
                            const entries = Object.entries(resultText).map(([key, value]) => `${key}: ${value}`).join(' | ');
                            resultDisplay.innerHTML = `<span class="text-cyber-green">$ </span><span class="ml-2 text-cyber-primary">${entries}</span>`;
                        }
                    } else if (typeof resultText === 'number') {
                        const formatted = resultText % 1 === 0 ? resultText.toString() : resultText.toFixed(6).replace(/\.?0+$/, '');
                        resultDisplay.innerHTML = `<span class="text-cyber-green">$ </span><span class="ml-2 text-cyber-accent text-xl">${formatted}</span>`;
                    } else {
                        resultDisplay.innerHTML = `<span class="text-cyber-green">$ </span><span class="ml-2 text-cyber-primary">${resultText}</span>`;
                    }
                }
            })
            .catch(error => {
                resultDisplay.innerHTML = `<span class="text-cyber-green">$ </span><span class="ml-2 text-red-500">连接错误: ${error.message}</span>`;
            });
        });

        function setupHessLawInterface() {
            const addBtn = document.querySelector('.add-equation-btn');
            const equationsList = document.querySelector('.equations-list');
            let equationCount = 0;
            
            addBtn.addEventListener('click', () => {
                equationCount++;
                const equationDiv = document.createElement('div');
                equationDiv.className = 'equation-item cyber-card rounded-lg p-4';
                equationDiv.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-cyber-green font-mono text-sm w-8">[${equationCount}]</span>
                        <input type="text" class="equation-input flex-1 cyber-input p-2 rounded font-mono" 
                               placeholder="方程式 (A + B -> C + D)">
                        <input type="number" step="any" class="enthalpy-input w-24 cyber-input p-2 rounded font-mono" 
                               placeholder="ΔH">
                        <span class="text-cyber-secondary font-mono text-sm">kJ/mol</span>
                        <button type="button" class="remove-equation-btn text-red-500 hover:text-red-300 px-2 font-mono">删除</button>
                    </div>
                `;
                equationsList.appendChild(equationDiv);
                
                equationDiv.querySelector('.remove-equation-btn').addEventListener('click', () => {
                    equationDiv.remove();
                    checkParams();
                });
                
                equationDiv.querySelectorAll('input').forEach(input => {
                    input.addEventListener('input', checkParams);
                });
                
                checkParams();
            });
            
            addBtn.click();
        }
        
        function getHessLawParams() {
            const equations = [];
            const equationItems = document.querySelectorAll('.equation-item');
            
            equationItems.forEach(item => {
                const equationInput = item.querySelector('.equation-input');
                const enthalpyInput = item.querySelector('.enthalpy-input');
                
                if (equationInput.value.trim() && enthalpyInput.value.trim()) {
                    equations.push([equationInput.value.trim(), parseFloat(enthalpyInput.value)]);
                }
            });
            
            const targetEquation = document.querySelectorAll('.param-input')[1]?.value.trim();
            
            return [equations, targetEquation];
        }

        function updateOperationSelect() {
            operationSelect.innerHTML = '<option value="">选择运算</option>';
            
            if (currentSubject) {
                const operations = subjectOperations[currentSubject].operations;
                
                for (const [key, value] of Object.entries(operations)) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = value.label;
                    operationSelect.appendChild(option);
                }
            }
        }

        function checkParams() {
            const operation = operationSelect.value;
            
            if (!operation) {
                calculateBtn.disabled = true;
                return;
            }
            
            let allRequiredFilled = true;
            const operationConfig = subjectOperations[currentSubject].operations[operation];
            const inputType = operationConfig.inputType || 'number';
            
            if (inputType === 'hess') {
                const equationItems = document.querySelectorAll('.equation-item');
                const targetInput = document.querySelectorAll('.param-input')[1];
                
                if (equationItems.length === 0 || !targetInput?.value.trim()) {
                    allRequiredFilled = false;
                } else {
                    equationItems.forEach(item => {
                        const equationInput = item.querySelector('.equation-input');
                        const enthalpyInput = item.querySelector('.enthalpy-input');
                        
                        if (!equationInput.value.trim() || !enthalpyInput.value.trim()) {
                            allRequiredFilled = false;
                        }
                    });
                }
            } else {
                const paramInputs = document.querySelectorAll('.param-input');
                
                paramInputs.forEach((input, index) => {
                    const value = input.value.trim();
                    const isOptional = input.dataset.optional === 'true';
                    
                    if (!isOptional && value === '') {
                        allRequiredFilled = false;
                    }
                });
            }
            
            calculateBtn.disabled = !allRequiredFilled;
        }
    </script>
</body>
</html>